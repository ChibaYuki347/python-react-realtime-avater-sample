"""
Azure RAG API routes - Azure Blob Storage + Azure AI Search を使用したRAG機能
"""
import os
import logging
from typing import Dict, Any, List, Optional
from fastapi import APIRouter, HTTPException, UploadFile, File, Form
from pydantic import BaseModel
from datetime import datetime

from services.azure_rag_service import AzureRAGService

logger = logging.getLogger(__name__)

# グローバルRAGサービスインスタンス
azure_rag_service = AzureRAGService()

# APIルーター
router = APIRouter(prefix="/api/azure-rag", tags=["Azure RAG"])

# Pydantic models
class RAGQueryRequest(BaseModel):
    query: str
    user_id: Optional[str] = None
    max_results: Optional[int] = 5

class RAGResponse(BaseModel):
    answer: str
    query: str
    relevant_documents: List[Dict[str, Any]]
    context_used: str
    user_id: Optional[str] = None
    timestamp: str

class DocumentUploadResponse(BaseModel):
    success: bool
    message: str
    blob_url: Optional[str] = None
    index_result: Optional[Dict[str, Any]] = None

class FolderProcessResponse(BaseModel):
    success: bool
    message: str
    summary: Dict[str, Any]

class StatusResponse(BaseModel):
    initialized: bool
    data_directory: str
    supported_extensions: List[str]
    file_status: Optional[Dict[str, Any]] = None

# Startup event
async def initialize_rag_service():
    """RAGサービス初期化"""
    try:
        success = await document_manager.initialize()
        if success:
            logger.info("RAG APIサービス初期化完了")
        else:
            logger.error("RAG APIサービス初期化失敗")
    except Exception as e:
        logger.error(f"RAG APIサービス初期化エラー: {e}")

# API Endpoints

@router.get("/status", response_model=StatusResponse)
async def get_rag_status():
    """RAGシステムの状態を取得"""
    try:
        # サービス初期化確認
        if not hasattr(document_manager, 'rag_service') or not document_manager.rag_service._initialized:
            await initialize_rag_service()
        
        # ファイル状況取得
        file_status = await document_manager.get_upload_status()
        
        return StatusResponse(
            initialized=document_manager.rag_service._initialized,
            data_directory=document_manager.get_data_directory(),
            supported_extensions=document_manager.get_supported_file_types(),
            file_status=file_status
        )
        
    except Exception as e:
        logger.error(f"ステータス取得エラー: {e}")
        raise HTTPException(status_code=500, detail=f"ステータス取得失敗: {str(e)}")

@router.post("/upload/directory", response_model=UploadResponse)
async def upload_directory():
    """データディレクトリ内の全ドキュメントをアップロード・インデックス化"""
    try:
        # サービス初期化確認
        if not hasattr(document_manager, 'rag_service') or not document_manager.rag_service._initialized:
            await initialize_rag_service()
        
        # ディレクトリアップロード実行
        result = await document_manager.upload_directory()
        
        return UploadResponse(**result)
        
    except Exception as e:
        logger.error(f"ディレクトリアップロードエラー: {e}")
        raise HTTPException(status_code=500, detail=f"アップロード失敗: {str(e)}")

@router.post("/search")
async def search_documents(request: SearchRequest):
    """ドキュメント検索"""
    try:
        # サービス初期化確認
        if not hasattr(document_manager, 'rag_service') or not document_manager.rag_service._initialized:
            await initialize_rag_service()
        
        # 検索実行
        results = await document_manager.search_documents(
            query=request.query,
            max_results=request.max_results
        )
        
        return {
            "query": request.query,
            "results": results,
            "result_count": len(results),
            "timestamp": datetime.now().isoformat()
        }
        
    except Exception as e:
        logger.error(f"ドキュメント検索エラー: {e}")
        raise HTTPException(status_code=500, detail=f"検索失敗: {str(e)}")

@router.post("/query", response_model=RAGResponse)
async def rag_query(request: RAGQueryRequest):
    """RAG応答生成"""
    try:
        # サービス初期化確認
        if not hasattr(document_manager, 'rag_service') or not document_manager.rag_service._initialized:
            await initialize_rag_service()
        
        # RAG応答生成
        response_data = await document_manager.generate_rag_response(
            user_id=request.user_id,
            query=request.query,
            conversation_id=request.conversation_id
        )
        
        return RAGResponse(**response_data)
        
    except Exception as e:
        logger.error(f"RAG応答生成エラー: {e}")
        raise HTTPException(status_code=500, detail=f"RAG応答生成失敗: {str(e)}")

@router.get("/health")
async def health_check():
    """ヘルスチェック"""
    try:
        # 基本的な初期化確認
        initialized = hasattr(document_manager, 'rag_service') and document_manager.rag_service._initialized
        
        return {
            "status": "healthy" if initialized else "initializing",
            "timestamp": datetime.now().isoformat(),
            "service_initialized": initialized
        }
        
    except Exception as e:
        logger.error(f"ヘルスチェックエラー: {e}")
        return {
            "status": "unhealthy",
            "timestamp": datetime.now().isoformat(),
            "error": str(e)
        }

# サンプルドキュメント用のエンドポイント
@router.post("/sample/create")
async def create_sample_documents():
    """サンプルドキュメントを作成（テスト用）"""
    try:
        from pathlib import Path
        
        data_dir = Path(document_manager.get_data_directory())
        data_dir.mkdir(exist_ok=True)
        
        # サンプルMarkdownファイル作成
        sample_content = """# プロジェクトについて

このプロジェクトは、PythonとReactを使用したリアルタイムカスタムアバターアプリケーションのサンプルです。

## 主な機能

- **リアルタイムアバター表示**: Azure Speech SDKを使用してアバターを表示
- **AI機能**: Azure OpenAI GPT-4.1を使用した会話機能
- **RAG機能**: Azure AI Search + Blob Storageを使用した検索拡張生成
- **音声合成**: カスタムボイスによる音声出力

## 技術スタック

### バックエンド
- FastAPI
- Azure Speech SDK
- Azure OpenAI
- Azure AI Search
- Azure Blob Storage

### フロントエンド
- React (TypeScript)
- Azure Speech SDK for JavaScript

## 使用方法

1. アバターに接続
2. AI会話モードまたは手動入力モードを選択
3. チャットまたは直接入力でアバターと対話

このサンプルプロジェクトは、最新のAzure AI サービスを活用した対話型アプリケーションの構築方法を示しています。
"""
        
        sample_file = data_dir / "project_info.md"
        with open(sample_file, 'w', encoding='utf-8') as f:
            f.write(sample_content)
        
        return {
            "success": True,
            "message": "サンプルドキュメントを作成しました",
            "created_files": [
                {
                    "name": "project_info.md",
                    "path": str(sample_file),
                    "size": len(sample_content)
                }
            ]
        }
        
    except Exception as e:
        logger.error(f"サンプルドキュメント作成エラー: {e}")
        raise HTTPException(status_code=500, detail=f"サンプルドキュメント作成失敗: {str(e)}")